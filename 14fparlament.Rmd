---
title: "Dibuixant les eleccions 14F"
author: "Pau Grau"
date: "15/2/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(sf)
library(tidyverse)
library(RSocrata)
library(patchwork)
```

# 1. Importar les dades

Per tal de treballar amb les dades, he descarregat de l'INE un fitxer ZIP amb les [dades actualitzades](https://www.ine.es/ss/Satellite?c=Page&cid=1259952026632&p=1259952026632&pagename=ProductosYServicios%2FPYSLayout) de les seccions censals (canvien entre eleccions segons el nombre d'habitants). Aquest fitxer està en format SHP i l'importo amb el paquet "sf" i la funció "st_read". 

Seguidament creo una variable que identifiqui cada secció censal de manera única, i conservo aquesta variable ("uniqueID") i "geometry", que conté) la informació necessària per fer el mapa.

```{r reduce_map, message=FALSE, warning=FALSE}
cat2020 <- sf::st_read(paste0(getwd(),"/seccionado_2020"))%>%
#  filter(NCA=="Cataluña")%>%
  mutate(CSEC=as.numeric(CSEC),
         CDIS=as.numeric(CDIS),
         CPRO=as.numeric(CPRO),
         CMUN=as.numeric(CMUN),
         uniqueID=paste0(CPRO, CMUN, CDIS, CSEC))%>%
  select(uniqueID, geometry)

```

```{r import_map, message=FALSE, warning=FALSE}
cat2020 <- sf::st_read(paste0(getwd(),"/seccionado_2020"))%>%
  filter(NCA=="Cataluña")%>%
  mutate(CSEC=as.numeric(CSEC),
         CDIS=as.numeric(CDIS),
         CPRO=as.numeric(CPRO),
         CMUN=as.numeric(CMUN),
         uniqueID=paste0(CPRO, CMUN, CDIS, CSEC))%>%
  select(uniqueID, geometry)

```

A continuació importo les dades de vot directament del [portal Dades Obertes de la Generalitat](https://analisi.transparenciacatalunya.cat/Societat-benestar/Eleccions-al-Parlament-de-Catalunya-2021-Recompte-/ix2p-vyw4). Fer-ho d'aquesta manera permet tenir les dades actualitzades en tot moment i no haver de descarregar cap fitxer manualment. Per poder-ho fer servir, però, cal crear un compte i introduir als espais en blanc de l'script el correu-e i la contrasenya. Com en el fitxer amb les dades geogràfiques, creo també la variable "uniqueID" i uneix les dues bases de dades amb la funció "left_join".

La funció "plot(st_geometry())" permet comprovar que les dades són correctes i hem ajuntat bé les dues bases de dades.

```{r import_data, include=FALSE}
df <- read.socrata(
  "https://analisi.transparenciacatalunya.cat/resource/ix2p-vyw4.json",
  email     = "pau.grau.v@gmail.com",
  password  = "Un2345678!")%>%
  mutate(uniqueID=paste0(codi_circumscripci, codi_municipi, districte, secci))
```

```{r eval=FALSE, include=TRUE}
df <- read.socrata(
  "https://analisi.transparenciacatalunya.cat/resource/ix2p-vyw4.json",
  email     = "",
  password  = "")%>%
  mutate(uniqueID=paste0(codi_circumscripci, codi_municipi, districte, secci))
```

```{r merge_data}
joined <- left_join(cat2020, df)
plot(st_geometry(joined))
```

# 2. Dibuixar els mapes

Un cop tenim les dades, fem servir el paquet ggplot (dins de tidyverse) per fer els mapes. Definim els colors de cada partit i el títol.


```{r mapes}
PSC <- ggplot() +
  geom_sf(data = joined, aes(
    fill = as.numeric(partit_dels_socialistes_de),
    color = as.numeric(partit_dels_socialistes_de)
    )) +
  coord_sf(crs = st_crs(joined), datum = NA) +
  scale_fill_gradient(low = "white", high = "#e73b39", breaks=c(0,25,50, 75),
                         labels=c("0%","25%", "50%", "75%"), "% de vots")+
  scale_color_gradient(low = "white", high = "#e73b39", guide=FALSE)+
  labs(title="PSC")+
  theme_void()

ERC <- ggplot() +
  geom_sf(data = joined, aes(
    fill = as.numeric(esquerra_republicana_de),
    color = as.numeric(esquerra_republicana_de)
    )) +
  coord_sf(crs = st_crs(joined), datum = NA) +
  scale_fill_gradient(low = "white", high = "#ffee00", breaks=c(0,25,50, 75),
                         labels=c("0%","25%", "50%", "75%"), "% de vots")+
  scale_color_gradient(low = "white", high = "#ffee00", guide=FALSE)+
  labs(title="ERC")+
  theme_void()

JXCAT <- ggplot() +
  geom_sf(data = joined, aes(
    fill = as.numeric(junts_per_catalunya_jxcat),
    color = as.numeric(junts_per_catalunya_jxcat)
    )) +
  coord_sf(crs = st_crs(joined), datum = NA) +
  scale_fill_gradient(low = "white", high = "#00c5b3", breaks=c(0,25,50, 75),
                         labels=c("0%","25%", "50%", "75%"), "% de vots")+
  scale_color_gradient(low = "white", high = "#00c5b3", guide=FALSE)+
  labs(title="Junts per Catalunya")+
  theme_void()

VOX <- ggplot() +
  geom_sf(data = joined, aes(
    fill = as.numeric(vox_vox),
    color = as.numeric(vox_vox)
    )) +
  coord_sf(crs = st_crs(joined), datum = NA) +
  scale_fill_gradient(low = "white", high = "#77b82a", breaks=c(0,25,50, 75),
                         labels=c("0%","25%", "50%", "75%"), "% de vots")+
  scale_color_gradient(low = "white", high = "#77b82a", guide=FALSE)+
  labs(title="VOX")+
  theme_void()

CUP <- ggplot() +
  geom_sf(data = joined, aes(
    fill = as.numeric(candidatura_d_unitat_popular),
    color = as.numeric(candidatura_d_unitat_popular)
    )) +
  coord_sf(crs = st_crs(joined), datum = NA) +
  scale_fill_gradient(low = "white", high = "#fff200", breaks=c(0,25,50, 75),
                         labels=c("0%","25%", "50%", "75%"), "% de vots")+
  scale_color_gradient(low = "white", high = "#fff200", guide=FALSE)+
  labs(title="CUP")+
  theme_void()

COMUNS <- ggplot() +
  geom_sf(data = joined, aes(
    fill = as.numeric(en_com_podem_podem_en_com),
    color = as.numeric(en_com_podem_podem_en_com)
    )) +
  coord_sf(crs = st_crs(joined), datum = NA) +
  scale_fill_gradient(low = "white", high = "#581866", breaks=c(0,25,50, 75),
                         labels=c("0%","25%", "50%", "75%"), "% de vots")+
  scale_color_gradient(low = "white", high = "#581866", guide=FALSE)+
  labs(title="En ComC: Podem")+
  theme_void()

CS <- ggplot() +
  geom_sf(data = joined, aes(
    fill = as.numeric(ciutadans_partido_de_la),
    color = as.numeric(ciutadans_partido_de_la)
    )) +
  coord_sf(crs = st_crs(joined), datum = NA) +
  scale_fill_gradient(low = "white", high = "#ff5001", breaks=c(0,25,50, 75),
                         labels=c("0%","25%", "50%", "75%"), "% de vots")+
  scale_color_gradient(low = "white", high = "#ff5001", guide=FALSE)+
  labs(title="Ciutadans")+
  theme_void()

PP <- ggplot() +
  geom_sf(data = joined, aes(
    fill = as.numeric(partit_popular_partido_popular),
    color = as.numeric(partit_popular_partido_popular)
    )) +
  coord_sf(crs = st_crs(joined), datum = NA) +
  scale_fill_gradient(low = "white", high = "#0d386c", breaks=c(0,25,50, 75),
                         labels=c("0%","25%", "50%", "75%"), "% de vots")+
  scale_color_gradient(low = "white", high = "#0d386c", guide=FALSE)+
  labs(title="PP")+
  theme_void()

PDCAT <- ggplot() +
  geom_sf(data = joined, aes(
    fill = as.numeric(partit_dem_crata_europeu),
    color = as.numeric(partit_dem_crata_europeu)
    )) +
  coord_sf(crs = st_crs(joined), datum = NA) +
  scale_fill_gradient(low = "white", high = "#005ca9", breaks=c(0,25,50, 75),
                         labels=c("0%","25%", "50%", "75%"), "% de vots")+
  scale_color_gradient(low = "white", high = "#005ca9", guide=FALSE)+
  labs(title="PDeCAT")+
  theme_void()

FNC <- ggplot() +
  geom_sf(data = joined, aes(
    fill = as.numeric(front_nacional_de_catalunya),
    color = as.numeric(front_nacional_de_catalunya)
    )) +
  coord_sf(crs = st_crs(joined), datum = NA) +
  scale_fill_gradient(low = "white", high = "#005ca9", breaks=c(0,25,50, 75),
                         labels=c("0%","25%", "50%", "75%"), "% de vots")+
  scale_color_gradient(low = "white", high = "#005ca9", guide=FALSE)+
  labs(title="FNC")+
  theme_void()
```

Un cop guardats els mapes, fem servir el paquet "patchwork" que permet integrar diferents gràfics en una mateixa imatge de manera molt senzilla i prou resolutiva.

```{r mapes_patch}
PSC+ERC+JXCAT+VOX+CUP+COMUNS+CS+PP
```

## Enllaços d'interès:

* Geocomputation with R: https://geocompr.robinlovelace.net/
* From Data to Viz: https://www.data-to-viz.com/
* Blog d'en Toni Rodon: http://www.tonirodon.cat/wp-content/uploads/2020/06/Tutorial-Mapes.html
